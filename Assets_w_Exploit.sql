/*

NAME  : Assets_w_Exploits.sql
AUTHOR: Alexandre Fukaya
DATE  : 07/04/2023
DESCRIPTION:
Lists all assets affected by vulnerabilities with a exploit or malware associated found on scannned assets. This report will
create a CSV file containing a list of all critical exploitable vulnerabilties with their associated assets.
    
DEPENDENCIES:
NA

TODO:
NA

CHANGELOG:
NA

DATA DICTIONARY:

table: dim_asset
Description: Dimension that provides access to the textual information of all assets configured to be within the scope of the 
report. Only the information from the most recent scan of each asset is used to provide an accumulating summary. There will 
be one record in this dimension for every single asset in scope, including assets specified through configuring scans, sites, 
or asset groups to be within scope.

Name               | Type         | Null | Description                                                                       | Dimension Table
asset_id           | bigint       | No   | The identifier of the asset.                                                      |
mac_address        | macaddr      | Yes  | The primary MAC address of the asset. If an asset has had no MAC address          |
                   |              |      | identified, the value will be null. If an asset has multiple MAC addresses, the   |
                   |              |      | primary or best address is selected.                                              |
ip_address         | inet         | No   | The primary IP address of the asset. If an asset has multiple IP addresses, the   |
                   |              |      | primary or best address is selected. The IP address may be an IPv4 or IPv6 address|
host_name          | text         | Yes  | The primary host name of the asset. If an asset has had no host name identified,  |
                   |              |      | the value will be null . If an asset has multiple host names, the primary or best |
                   |              |      | address is selected. If the asset was scanned as a result of configuring the site |
                   |              |      | with a host name target, that name will be guaranteed to be selected ss the       |
                   |              |      | primary host name.                                                                |
operating_system_id| bigint       | No   | The identifier of the operating system fingerprint with the highest certainty on  |
                   |              |      | the asset. If the asset has no operating system fingerprinted, the value will be  |
                   |              |      | -1.                                                                               | dim_operating_system
host_type_id       | integer      | No   | The identifier of the type of host the asset is classified as. If the host type   |
                   |              |      | could not be detected, the value will be -1.                                      | dim_host_type
sites              | text         | No   | Comma separated list of site names.                                               |
last_assessed_for_v| timestamp    | Yes  | The time at which the asset was last scanned for vulnerabilities. If the asset    | 
ulnerabilities     |              |      | has never been scanned for vulnerabilities, the value will be null.               |

table: dim_asset_vulnerability_best_solution
Description: Dimension that provides access to the best solution that is recommended to remediate a vulnerability on an asset.
Name               | Type         | Null | Description                                                                       | Dimension Table
asset_id           | bigint       | No   | The surrogate identifier of the asset.                                            | dim_asset
vulnerability_id   | integer      | No   | The identifier of the vulnerability.                                              | dim_vulnerability
solution_id        | integer      | No   | The surrogate identifier of the solution that may be used to remediate the        |
                   |              |      | vulnerability on the asset.                                                       |

Table: dim_operating_system
Description: Dimension provides access to all operating system fingerprints detected on assets in any scan of the assets 
             within the scope of the report.
Name               | Type         | Null | Description                                                                       | Dimension Table
operating_system_id| bigint       | No   | The identifier of the operating system.                                           |
asset_type         | text         | No   | The type of asset the operating system applies to, which categorizes the          |
                   |              |      | operating system fingerprint. This type can distinguish the purpose of the asset  |
                   |              |      | that the operating system applies to.                                             |
description        | text         | No   | The verbose description of the operating system, which combines the family,       |
                   |              |      | vendor, name, and version.                                                        |
vendor             | text         | No   | The vendor or publisher of the operating system. If the vendor was not detected,  |
                   |              |      | the value will be 'Unknown'.                                                      | 
family             | text         | No   | The family or product line of the operating system. If the family was not         |
                   |              |      | detected, the value will be 'Unknown'.                                            |
name               | text         | No   | The name of the operating system. If the name was not detected, the value will be |
                   |              |      | 'Unknown'.                                                                        |   
version            | text         | No   | The version of the operating system. If the version was not detected, the value   |
                   |              |      | will be 'Unknown'.                                                                |
architecture       | text         | No   | The architecture the operating system is built for. If the architecture was not   |
                   |              |      | detected, the value will be 'Unknown'.                                            |
system             | text         | No   | The terse description of the operating system, which combines the vendor and      |
                   |              |      | family.                                                                           |
cpe                | text         | Yes  | The Common Platform Enumeration (CPE) value that corresponds to the operating     |
                   |              |      | system.                                                                           |

Table: dim_vulnerability
Description: Dimension for all the metadata related to a vulnerability. This dimension will contain one record for every 
             vulnerability included within the scope of the report.  

Name               | Type         | Null | Description                                                                       | Dimension Table
vulnerability_id   | integer      | No   | The identifier of the vulnerability.                                              |
title              | text         | No   | The short, succinct title of the vulnerability.                                   |
severity_score     | smallint     | No   | The numerical severity of the vulnerability, measured on a scale of 0 to 10 using |
                   |              |      | whole numbers. A value of zero indicates low severity, and a value of 10 indicates| 
		     |              |      | high severity.                                                                    |
severity           | text         | No   | A human-readable description of the severity_score value. Possible values are     |
                   |              |      | 'Critical' , 'Severe' , and 'Moderate'.                                           |
riskscore          | double       | No   | The risk score of the vulnerability as computed by the risk model currently       |
                   |              |      | configured on the Security Console.                                               |
cvss_score         | real         | No   | The CVSS score of the vulnerability, on a scale of 0 to 10.                       |
exploits           | bigint       | No   | The number of distinct exploits that are associated with the vulnerability. If no |
                   |              |      | exploits are associated to this vulnerability, the value will be zero.            |
malware_kits       | bigint       | No   | The number of malware kits that are associated with the vulnerability. If no      |
                   |              |      | malware kits are associated to this vulnerability, the value will be zero.        |

Table: dim_vulnerability_exploit
Description: Dimension that provides the relationship between a vulnerability and an exploit.                  
Name               | Type         | Null | Description                                                                       | Dimension Table
exploit_id         | integer      | No   | The identifier of the exploit.                                                    |
vulnerability_id   | integer      | No   | The identifier of the vulnerability.                                              | dim_vulnerability
title              | text         | No   | The short, succinct title of the exploit.                                         |
description        | text         | Yes  | The optional verbose description of the exploit. If there is no description, the  |
                   |              |      | value is null.                                                                    |
skill_level        | text         | No   | The skill level required to perform the exploit. Possible values include 'Expert',|
                   |              |      | 'Novice', and 'Intermediate'.                                                     |
source_id          | text         | No   | The source which defined and published the exploit. Possible values include       |
                   |              |      | 'Exploit DB' and 'Metasploit Module'.                                             |

Table: fact_vulnerability
Description: The fact_vulnerability table provides a summarized record for each vulnerability within the scope of the report.
             For each vulnerability, the count of assets subject to the vulnerability is measured. Only assets with a finding 
	      in their most recent scan with no exception applied are included in the totals.

Name               | Type         | Null | Description                                                                       | Dimension Table
vulnerability_id   | integer      | No   | The identifier of the vulnerability                                               | dim_vulnerability 
affected_assets    | bigint       | No   | The number of assets that have the vulnerability. This count may be zero if no    |
                   |              |      | assets are vulnerable.                                                            |
vulnerability_inst | bigint       | No   | The number of instances or occurrences of the vulnerability across all assets.    |
ances              |              |      |                                                                                   |
most_recently_disc | timestamp    | No   | The most recent date and time at which any asset within the scope of the report   |
overed             |              |      | was discovered to be vulnerable to the vulnerability.                             |

*/

SELECT dv.title, dv.severity_score, dv.severity, dv.exploits, 
       dve.title, dve.description, dve.skill_level, dve.source,
       da.host_name, da.ip_address, dos.name
	   
FROM dim_vulnerability as dv
JOIN dim_vulnerability_exploit AS dve USING (vulnerability_id)
JOIN dim_asset_vulnerability_best_solution AS davbs USING (vulnerability_id)
JOIN fact_vulnerability AS fa USING (vulnerability_id)
JOIN dim_asset AS da on davbs.asset_id = da.asset_id
JOIN dim_operating_system AS dos on da.operating_system_id = dos.operating_system_id

WHERE dv.severity = 'Critical' AND dv.exploits <> 0 AND dv.malware_kits <> 0 AND fa.affected_assets > 0


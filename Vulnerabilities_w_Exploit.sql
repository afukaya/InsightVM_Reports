/*
NAME  : Vulnerabilities_w_Exploits.sql
AUTHOR: Alexandre Fukaya
DATE  : 07/04/2023
DESCRIPTION:
Lists all vulnerabilities with a exploit or malware associated found on scannned assets. This report will create a 
CSV file with information from all critical vulnerabilities with exploits associated.
    
DEPENDENCIES:
NA

TODO:
NA

CHANGELOG:
NA

DATA DICTIONARY:

Table: fact_vulnerability
Description: The fact_vulnerability table provides a summarized record for each vulnerability within the scope of the report.
             For each vulnerability, the count of assets subject to the vulnerability is measured. Only assets with a finding 
	      in their most recent scan with no exception applied are included in the totals.

Name               | Type         | Null | Description                                                                       | Dimension Table
vulnerability_id   | integer      | No   | The identifier of the vulnerability                                               | dim_vulnerability 
affected_assets    | bigint       | No   | The number of assets that have the vulnerability. This count may be zero if no    |
                   |              |      | assets are vulnerable.                                                            |
vulnerability_inst | bigint       | No   | The number of instances or occurrences of the vulnerability across all assets.    |
ances              |              |      |                                                                                   |
most_recently_disc | timestamp    | No   | The most recent date and time at which any asset within the scope of the report   |
overed             |              |      | was discovered to be vulnerable to the vulnerability.                             |


Table: dim_vulnerability
Descritption: Dimension for all the metadata related to a vulnerability. This dimension will contain one recordfor every
              vulnerability included within the scope of the report.

Name               | Type         | Null | Description                                                                       | Dimension Table
vulnerability_id   | integer      | No   | The identifier of the vulnerability.                                              |
title              | text         | No   | The short, succinct title of the vulnerability.                                   |
severity_score     | smallint     | No   | The numerical severity of the vulnerability, measured on a scale of 0 to 10 using |
                   |              |      | whole numbers. A value of zero indicates low severity, and a value of 10 indicates|
                   |              |      | high severity.                                                                    |
severity           | text         | No   | A human-readable description of the severity_score value. Possible values are     |
                   |              |      | 'Critical' , 'Severe' , and 'Moderate'.                                           |
riskscore          | double       | No   | The risk score of the vulnerability as computed by the risk model currently       |
                   |              |      | configured on the Security Console.                                               |
cvss_score         | real         | No   | The CVSS score of the vulnerability, on a scale of 0 to 10.                       |
exploits           | bigint       | No   | The number of distinct exploits that are associated with the vulnerability. If no |
                   |              |      | exploits are associated to this vulnerability, the value will be zero.            |
malware_kits       | bigint       | No   | The number of malware kits that are associated with the vulnerability. If no      |
                   |              |      | malware kits are associated to this vulnerability, the value will be zero.        |

Table: dim_vulnerability_exploit
Description: Dimension that provides the relationship between a vulnerability and an exploit.                  
Name               | Type         | Null | Description                                                                       | Dimension Table
exploit_id         | integer      | No   | The identifier of the exploit.                                                    |
vulnerability_id   | integer      | No   | The identifier of the vulnerability.                                              | dim_vulnerability
title              | text         | No   | The short, succinct title of the exploit.                                         |
description        | text         | Yes  | The optional verbose description of the exploit. If there is no description, the  |
                   |              |      | value is null.                                                                    |
skill_level        | text         | No   | The skill level required to perform the exploit. Possible values include 'Expert',|
                   |              |      | 'Novice', and 'Intermediate'.                                                     |
source_id          | text         | No   | The source which defined and published the exploit. Possible values include       |
                   |              |      | 'Exploit DB' and 'Metasploit Module'.                                             |


*/

SELECT dv.vulnerability_id, dv.title, dv.severity_score, dv.severity, dv.riskscore, dv.cvss_score, dv.exploits, dv.malware_kits, 
       dve.exploit_id, dve.vulnerability_id, dve.title, dve.description, dve.skill_level, dve.source, fa.affected_assets, fa.vulnerability_instances
FROM dim_vulnerability as dv
JOIN dim_vulnerability_exploit AS dve USING (vulnerability_id)
JOIN fact_vulnerability AS fa USING (vulnerability_id)
WHERE dv.severity = 'Critical' AND dv.exploits <> 0 AND dv.malware_kits <> 0 AND fa.affected_assets > 0
ORDER BY dv.malware_kits DESC, dv.exploits DESC, dv.riskscore DESC